---
layout: post
category : database
title: db_bench测试rocksdb性能
tags : [rocksdb, gcc]
---
{% include JB/setup %}

### why 

学习下sysbench 和sysbench-tpcc，做测试。

---

首先取sysbench<sup>1</sup>，我是取源码传到服务器的，可能有些编译问题。

 ```
cd sysbench
chmod 777 *
chmod 777 third_party/concurrency_kit/ck/*
chmod 777 third_party/cram/*
chmod 777 third_party/luajit/luajit/*
./autogen.sh    
./configure --with-pgsql
make -j4
make install
 ```

遇到的问题

- autogen会遇到 `configure.ac:61: error: possibly undefined macro: AC_PROG_LIBTOOL` ，可以安装libtool`yum install libtool`解决
- configure会提示缺少mysql-devel和postgre-devel，按照提示安装就行
- make提示编译ck失败，提示luajit没编译上，注意权限。

取sysbench-tpcc<sup>2</sup>

拿postgresql做个试验<sup>3</sup>

```shell
sudo yum install postgresql-server postgresql-contrib
//按需更改data文件目录
#vim /usr/lib/systemd/system/postgresql.service
postgresql-setup initdb
systemctl start postgresql
```

需要建个新账号和新库 

 ```bash
sudo -u postgres psql postgres#登录
create user sb password w;# sysbench, 注意分号结尾
create database sbtest owenr sb;#建测试库
 ```



```shell
$ ./tpcc.lua --pgsql-user=postgres --pgsql-db=sbtest --time=120 --threads=56 --report-interval=1 --tables=10 --scale=100 --use_fk=0  --trx_level=RC --db-driver=pgsql prepare
```

提示--trx_level=RC不存在？我去掉了这个配置，注意还需要密码// 这个是不是事务配置？

```shell
 ./tpcc.lua --pgsql-user=sb --pgsql-password=‘w’ --pgsql- db=sbtest --time=120 --threads=56 --report-interval=1 --tables=10 --scale=100 --use_fk=0  --db- driver=pgsql prepare
```

还会提示[Ident authentication failed for user “…”](https://serverfault.com/questions/406606/postgres-error-message-fatal-ident-authentication-failed-for-user) 

```

```

可以点击看stackoverflow解决办法，或者直接改pg_hba.conf （这个文件在data目录内）把所有ident认证的地方改成md5 注意，是测试用，知道自己在做什么。<sup>4</sup>

记得重启

执行prepare时间还挺长，还以为卡死，抓pstack不像，看top有消耗还在跑 已经跑了一个小时了。





看到这里或许你有建议或者疑问，我的邮箱wanghenshui@qq.com 先谢指教。

### reference

1. sysbench repo and build https://github.com/akopytov/sysbench#building-and-installing-from-source
2. <https://github.com/Percona-Lab/sysbench-tpcc>
   1. <https://www.percona.com/blog/2018/03/05/tpcc-like-workload-sysbench-1-0/>
3. 测pg 的例子<https://www.percona.com/blog/2018/06/15/tuning-postgresql-for-sysbench-tpcc/
4. <https://help.ubuntu.com/stable/serverguide/postgresql.html>
5. sysbench 参数介绍 <https://wing324.github.io/2017/02/07/sysbench%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3/>
6. 一个sysbench-oltp lua脚本。可以改改加上mongodb ，同时也得合入 sysbench mongo driver 是个大活<https://github.com/Percona-Lab/sysbench-mongodb-lua>
7. <https://github.com/Percona-Lab/sysbench/tree/dev-mongodb-support-1.0>
8. <https://www.percona.com/blog/2016/05/13/benchmark-mongodb-sysbench/>
